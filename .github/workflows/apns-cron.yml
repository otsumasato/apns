name: apns-cron
on:
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆActions ã« Run workflow ãƒœã‚¿ãƒ³ãŒå‡ºã¾ã™ï¼‰
  workflow_dispatch:
    inputs:
      device_token:
        description: "Override device token (optional)"
        required: false
      env:
        description: "APNs environment"
        type: choice
        options: [sandbox, production]
        default: sandbox
  # 5åˆ†ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œã—ãŸã„å ´åˆã¯ä¸‹ã‚’ã‚¢ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ
  # schedule:
  #   - cron: "*/5 * * * *"   # UTCã§5åˆ†ãŠãï¼ˆJSTã§00,05,10â€¦åˆ†ï¼‰

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }

      - name: Install deps (JWT only)
        run: |
          python -V
          pip install "PyJWT>=2.8" "cryptography>=42"

      # âœ… Secrets ãŒâ€œå­˜åœ¨ã™ã‚‹ã‹ã ã‘â€ã‚’ç¢ºèªï¼ˆä¸­èº«ã¯è¡¨ç¤ºã—ãªã„ï¼‰
      - name: Check secrets presence (no values printed)
        shell: bash
        env:
          S_TEAM:  ${{ secrets.APNS_TEAM_ID }}
          S_KEY:   ${{ secrets.APNS_KEY_ID }}
          S_PEM:   ${{ secrets.APNS_P8_PEM || secrets.APN_SECRETS }}
          S_TOPIC: ${{ secrets.APNS_TOPIC }}
          S_DEVS:  ${{ secrets.DEVICE_TOKENS }}
        run: |
          for v in S_TEAM S_KEY S_PEM S_TOPIC; do
            if [ -z "${!v}" ]; then echo "âŒ $v is EMPTY"; exit 1; else echo "âœ… $v is set"; fi
          done
          if [ -z "${S_DEVS}" ]; then echo "â„¹ï¸ DEVICE_TOKENS is empty (you can input device_token at runtime)"; else echo "âœ… DEVICE_TOKENS is set"; fi

      # ðŸ” JWT ã‚’ä½œæˆï¼ˆPEM / \næ–‡å­—åˆ— / Base64 / DER ã®ã©ã‚Œã§ã‚‚è§£é‡ˆã€‚APNS_P8_PEM ãŒç„¡ã‘ã‚Œã° APN_SECRETS ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      - name: Build JWT (robust key loader)
        id: jwt
        shell: python
        env:
          APNS_TEAM_ID: ${{ secrets.APNS_TEAM_ID }}
          APNS_KEY_ID:  ${{ secrets.APNS_KEY_ID }}
          APNS_P8_PEM:  ${{ secrets.APNS_P8_PEM }}
          APN_SECRETS:  ${{ secrets.APN_SECRETS }}
        run: |
          import os, time, base64, re, jwt
          from cryptography.hazmat.primitives import serialization

          TEAM_ID = os.environ["APNS_TEAM_ID"].strip()
          KEY_ID  = os.environ["APNS_KEY_ID"].strip()
          S       = os.environ.get("APNS_P8_PEM") or os.environ.get("APN_SECRETS") or ""

          def load_key(s: str):
              s = s.strip().strip('`"\'')
              # \n æ–‡å­—åˆ— â†’ å®Ÿæ”¹è¡Œ
              if "\\n" in s and "BEGIN" in s:
                  try:
                      return serialization.load_pem_private_key(s.replace("\\n","\n").encode(), None)
                  except Exception:
                      pass
              # PEM ãã®ã¾ã¾
              if "BEGIN PRIVATE KEY" in s:
                  return serialization.load_pem_private_key(s.encode(), None)
              # Base64/URL-safe ã‚’è©¦ã™ï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°è£œæ­£ï¼‰
              compact = re.sub(r"\s+", "", s)
              pad = "=" * ((4 - len(compact) % 4) % 4)
              try:
                  b = base64.b64decode(compact + pad, validate=False)
              except Exception:
                  from base64 import urlsafe_b64decode
                  b = urlsafe_b64decode(compact + pad)
              # ãƒ‡ã‚³ãƒ¼ãƒ‰çµæžœãŒ PEM ãƒ†ã‚­ã‚¹ãƒˆãªã‚‰ PEM ã¨ã—ã¦ã€ãã†ã§ãªã‘ã‚Œã° DER ã¨ã—ã¦èª­ã‚€
              if b.startswith(b"-----BEGIN"):
                  return serialization.load_pem_private_key(b, None)
              return serialization.load_der_private_key(b, None)

          key = load_key(S)
          token = jwt.encode({"iss": TEAM_ID, "iat": int(time.time())},
                             key, algorithm="ES256", headers={"kid": KEY_ID})
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"token={token}\n")

      # ðŸš€ APNs ã¸ HTTP/2 ã§é€ä¿¡ï¼ˆcurl ä½¿ç”¨ï¼‰ã€‚device_token ã¯å…¥åŠ› > Secrets/Variables ã®é †ã§å–å¾—
      - name: Send APNs via HTTP/2 (curl)
        shell: bash
        env:
          JWT:            ${{ steps.jwt.outputs.token }}
          APNS_TOPIC:     ${{ secrets.APNS_TOPIC }}
          DEFAULT_TOKEN:  ${{ secrets.DEVICE_TOKENS || vars.DEVICE_TOKENS }}
          DEFAULT_ENV:    ${{ secrets.APNS_ENV   || vars.APNS_ENV }}
          INPUT_TOKEN:    ${{ inputs.device_token }}
          INPUT_ENV:      ${{ inputs.env }}
        run: |
          set -euo pipefail
          echo "curl version:"; curl -V

          # ãƒˆãƒ¼ã‚¯ãƒ³ï¼šå…¥åŠ› > Secrets/Varsã€‚ç©ºç™½/æ”¹è¡Œé™¤åŽ»ã€ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šãªã‚‰å…ˆé ­ã‚’ä½¿ç”¨
          RAW="${INPUT_TOKEN:-${DEFAULT_TOKEN:-}}"
          RAW="${RAW//$'\r'/}"; RAW="${RAW//$'\n'/}"
          RAW="$(echo -n "$RAW" | tr -d '[:space:]')"
          TOKEN="${RAW%%,*}"
          if [ -z "${TOKEN:-}" ]; then
            echo "âŒ device_token ãŒæœªè¨­å®šï¼ˆå®Ÿè¡Œæ™‚å…¥åŠ› or DEVICE_TOKENS ã‚’è¨­å®šï¼‰"; exit 1;
          fi

          ENV="${INPUT_ENV:-${DEFAULT_ENV:-sandbox}}"
          if [ "${ENV}" = "production" ]; then
            HOST="https://api.push.apple.com"
          else
            HOST="https://api.sandbox.push.apple.com"
          fi

          TICK_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{\"aps\":{\"content-available\":1},\"tick\":\"${TICK_UTC}\"}" > body.json

          echo "ENV=${ENV}  TOKEN(head)=${TOKEN:0:12}â€¦  tick=${TICK_UTC}"

          set -x
          curl --http2 -sS -D headers.txt \
            -H "authorization: bearer ${JWT}" \
            -H "apns-topic: ${APNS_TOPIC}" \
            -H "apns-push-type: background" \
            -H "apns-priority: 5" \
            -d @body.json \
            "${HOST}/3/device/${TOKEN}" \
            -o response.json
          set
