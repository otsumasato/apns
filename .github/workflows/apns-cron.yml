name: one-time-apns
on:
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install JWT deps
        run: |
          python -V
          pip install "PyJWT>=2.8" "cryptography>=42"

      # ✅ ここで JWT を生成（heredoc 不使用）
      - name: Build JWT (safe, no heredoc)
        id: jwt
        shell: python
        run: |
          import time, os, jwt
          from cryptography.hazmat.primitives import serialization

          TEAM_ID = "8KVP2QK7BX"
          KEY_ID  = "5W5TK89GQC"
          P8_PEM = """-----BEGIN PRIVATE KEY-----
          MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgfUyrzATs1Sjn4u9w
          YeJH3LGx67sZPBoVJxHW3C7+dDWgCgYIKoZIzj0DAQehRANCAAQ+sq5rw5HiL6Jo
          LsGWWVfDqTmnYR9LqkKWG3ea+7flLPbRo6UKyuRyQXZ/wrRmVMR+Q5IkrPt4ogIt
          Mig6kHa4
          -----END PRIVATE KEY-----"""

          priv = serialization.load_pem_private_key(P8_PEM.encode("utf-8"), password=None)
          token = jwt.encode({"iss": TEAM
